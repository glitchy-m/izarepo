<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personal Reminders V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg: #f9f9f9;
            --fg: #333;
            --accent: #007bff;
            --accent-hover: #0056b3;
            --item-bg: #fff;
            --item-fg: #333;
            --menu-bg: #ffffff;
            --menu-fg: #333;
            --menu-hover-bg: #f0f0f0;
            --menu-hover-fg: #000;
            --separator-color: #e0e0e0;
            --input-border: #ccc;
            --shadow-color: rgba(0,0,0,0.1);
            --modal-bg: rgba(0, 0, 0, 0.6);
            --button-text: #fff;
            --input-bg: #fff;
            --input-fg: #333;
        }

        .theme-default { --bg: #f9f9f9; --fg: #333; --accent: #007bff; --accent-hover: #0056b3; --item-bg: #fff; --item-fg: #333; --menu-bg: #fff; --menu-fg: #333; --menu-hover-bg: #f0f0f0; --separator-color: #e0e0e0; --input-border: #ccc; --button-text: #fff; --input-bg: #fff; --input-fg: #333;}
        .theme-dark    { --bg: #1a1a1a; --fg: #e0e0e0; --accent: #ff9800; --accent-hover: #e68900; --item-bg: #2a2a2a; --item-fg: #e0e0e0; --menu-bg: #252525; --menu-fg: #e0e0e0; --menu-hover-bg: #353535; --separator-color: #444; --input-border: #555; --button-text: #000; --input-bg: #2a2a2a; --input-fg: #e0e0e0;}
        .theme-blue    { --bg: #e3f2fd; --fg: #0d47a1; --accent: #2196f3; --accent-hover: #1976d2; --item-bg: #ffffff; --item-fg: #0d47a1; --menu-bg: #fff; --menu-fg: #0d47a1; --menu-hover-bg: #bbdefb; --separator-color: #b3e5fc; --input-border: #90caf9; --button-text: #fff; --input-bg: #fff; --input-fg: #0d47a1;}
        .theme-green   { --bg: #e8f5e9; --fg: #1b5e20; --accent: #4caf50; --accent-hover: #388e3c; --item-bg: #ffffff; --item-fg: #1b5e20; --menu-bg: #fff; --menu-fg: #1b5e20; --menu-hover-bg: #c8e6c9; --separator-color: #a5d6a7; --input-border: #81c784; --button-text: #fff; --input-bg: #fff; --input-fg: #1b5e20;}
        .theme-purple  { --bg: #f3e5f5; --fg: #4a148c; --accent: #9c27b0; --accent-hover: #7b1fa2; --item-bg: #ffffff; --item-fg: #4a148c; --menu-bg: #fff; --menu-fg: #4a148c; --menu-hover-bg: #e1bee7; --separator-color: #ce93d8; --input-border: #ba68c8; --button-text: #fff; --input-bg: #fff; --input-fg: #4a148c;}
        .theme-orange  { --bg: #fff3e0; --fg: #e65100; --accent: #ff9800; --accent-hover: #f57c00; --item-bg: #ffffff; --item-fg: #e65100; --menu-bg: #fff; --menu-fg: #e65100; --menu-hover-bg: #ffe0b2; --separator-color: #ffcc80; --input-border: #ffb74d; --button-text: #000; --input-bg: #fff; --input-fg: #e65100;}
        .theme-teal    { --bg: #e0f2f1; --fg: #004d40; --accent: #009688; --accent-hover: #00796b; --item-bg: #ffffff; --item-fg: #004d40; --menu-bg: #fff; --menu-fg: #004d40; --menu-hover-bg: #b2dfdb; --separator-color: #80cbc4; --input-border: #4db6ac; --button-text: #fff; --input-bg: #fff; --input-fg: #004d40;}
        .theme-custom  { /* Dynamically set */ }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
          font-family: 'Inter', sans-serif;
          background: var(--bg);
          color: var(--fg);
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          padding: 1rem;
          transition: background 0.3s ease, color 0.3s ease;
        }
        #root { width: 100%; display: flex; justify-content: center; align-items: center; }

        .container {
          background: var(--item-bg);
          color: var(--item-fg);
          border-radius: 12px;
          box-shadow: 0 6px 24px var(--shadow-color);
          width: 100%; max-width: 500px;
          padding: 2rem;
          position: relative;
          transition: background 0.3s ease, color 0.3s ease;
        }
        h1 { font-size: 1.75rem; margin-bottom: 1rem; font-weight: 700; }
        h2 { font-size: 1.25rem; margin-bottom: 1rem; font-weight: 600; }
        .greeting { margin-bottom: 1.5rem; font-size: 1.5rem; }
        .separator { border-top: 1px solid var(--separator-color); margin: 1.5rem 0; }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--fg); }
        label { display: block; margin-bottom: .5rem; font-weight: 600; font-size: 0.9rem; }

        input[type="text"], input[type="date"], input.flatpickr-input, select {
            width: 100%;
            padding: .75rem;
            border: 1px solid var(--input-border, var(--input-border));
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--input-bg, var(--bg));
            color: var(--input-fg, var(--fg));
            transition: border-color 0.2s ease, background 0.3s, color 0.3s;
        }
        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-hover);
            color: var(--input-fg, var(--fg));
        }

        button {
            background: var(--accent); color: var(--button-text);
            border: none; padding: .75rem 1.5rem;
            border-radius: 8px; cursor: pointer;
            font-weight: 600; font-size: 0.9rem;
            transition: background-color .2s ease, color .2s ease, transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        button:hover { background: var(--accent-hover); }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: var(--menu-hover-bg); color: var(--menu-fg); }
        button.secondary:hover { background-color: var(--separator-color); }
        button.danger { background-color: #e74c3c; color: #fff;}
        button.danger:hover { background-color: #c0392b; }
        button.icon-btn { padding: 0.5rem; min-width: auto; font-size: 1.2rem; }

        .form-group { margin-bottom: 1.5rem; }
        .form-actions { margin-top: 1rem; text-align: right; }

        .reminder-list { list-style: none; margin-top: 1rem; }
        .reminder-item {
            background: var(--bg);
            color: var(--fg);
            display: flex; align-items: center;
            justify-content: space-between; padding: 1rem;
            border-radius: 8px; margin-bottom: .75rem;
            border: 1px solid var(--separator-color);
            transition: transform .3s ease, opacity .3s ease, background 0.3s, color 0.3s;
            pointer-events: auto;
        }
        .reminder-item.completed .reminder-text { text-decoration: line-through; opacity: 0.6; }
        .reminder-item.slide-out { transform: translateX(100%); opacity: 0; }
        .reminder-details { display: flex; align-items: center; gap: .75rem; flex-grow: 1; }
        .reminder-details input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        .reminder-text { flex-grow: 1; }
        .reminder-date { font-size: 0.85rem; opacity: 0.8; margin-left: 0.5rem; white-space: nowrap; color: var(--accent);}
        .reminder-item-actions { display: flex; gap: 0.5rem; margin-left: 1rem; }
        .trash-btn {
            background: none; border: none; cursor: pointer;
            width: 28px; height: 28px; color: #e74c3c;
            transition: transform .2s ease, color 0.2s ease;
            font-size: 1rem;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 50%;
            padding: 0;
        }
        .trash-btn:hover { transform: scale(1.15); background-color: rgba(231, 76, 60, 0.1); }

        .due-banner { background: #ffe0e0; color: #c0392b; padding: 1rem; border-radius: 8px; text-align: center; margin-bottom: 1.5rem; font-weight: 600; border: 1px solid #f5c6cb; }
        @keyframes shake { 0%{transform:translateX(0);} 25%{transform:translateX(3px);} 50%{transform:translateX(0);} 75%{transform:translateX(-3px);} 100%{transform:translateX(0);} }
        .shake { animation: shake 0.5s ease-in-out 2; }

        .toolbar { position: absolute; top: 1rem; right: 1rem; z-index: 10; }
        .settings-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: var(--menu-bg);
            color: var(--menu-fg);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            overflow: hidden;
            z-index: 10;
            width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity .2s ease, transform .2s ease, visibility 0s .2s linear;
            border: 1px solid var(--separator-color);
        }
        .settings-menu.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            transition: opacity .2s ease, transform .2s ease, visibility 0s 0s linear;
        }
        .settings-menu-section { padding: 0.75rem 1rem; }
        .settings-menu-section .title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--fg);
            opacity: 0.7;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
        }
        .settings-menu ul { list-style: none; padding: 0; margin: 0; }
        .settings-menu li button {
            background: none; border: none;
            padding: .8rem 1rem; width: 100%; text-align: left;
            cursor: pointer;
            color: var(--menu-fg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            border-radius: 0;
            transition: background-color 0.2s, color 0.2s;
        }
        .settings-menu li button i { width: 18px; text-align: center; opacity: 0.8; }
        .settings-menu li button:hover { background: var(--menu-hover-bg); color: var(--menu-hover-fg); }
        .settings-menu .separator { margin: 0.5rem 0; border-color: var(--separator-color); }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 0.5rem;
            padding: 0.5rem 1rem 1rem 1rem;
        }
        .theme-button {
            width: 100%;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s;
        }
        .theme-button.active { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent); }
        .theme-button:hover { border-color: var(--fg); opacity: 0.8; }
        .theme-button span { display: none; }
        .theme-button[data-theme="default"] { background-color: #f9f9f9; border-color: #ccc; }
        .theme-button[data-theme="dark"] { background-color: #222; border-color: #555; }
        .theme-button[data-theme="blue"] { background-color: #e3f2fd; border-color: #90caf9; }
        .theme-button[data-theme="green"] { background-color: #e8f5e9; border-color: #81c784; }
        .theme-button[data-theme="purple"] { background-color: #f3e5f5; border-color: #ba68c8; }
        .theme-button[data-theme="orange"] { background-color: #fff3e0; border-color: #ffb74d; }
        .theme-button[data-theme="teal"] { background-color: #e0f2f1; border-color: #4db6ac; }

        .settings-menu li button.custom-theme-btn {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: #fff;
            font-weight: 600;
            justify-content: center;
        }
        .settings-menu li button.custom-theme-btn:hover {
            opacity: 0.9;
        }

        .modal-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: var(--modal-bg);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s 0.3s linear;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0s 0s linear;
        }
        .modal-content {
            background: var(--item-bg);
            color: var(--item-fg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%; max-width: 400px;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
        .modal-content h2 { margin-top: 0; color: var(--fg); }
        .modal-content p { margin-bottom: 1.5rem; }
        .modal-content input[type="text"],
        .modal-content input[type="color"],
        .modal-content select {
            margin-top: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }
         .modal-content input[type="color"] {
            height: 40px;
            padding: 0.25rem;
         }
        .modal-actions { margin-top: 1.5rem; display: flex; justify-content: center; gap: 1rem; }

        #allView { display: block; }
        #allView .reminder-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
        .all-reminder-details > div { margin-bottom: 0.3rem; }
        .all-reminder-details strong { font-weight: 600; }
        .all-reminder-details small { opacity: 0.8; font-size: 0.85rem; }
        .reminder-actions { margin-top: 1rem; display: flex; gap: 1rem; align-items: center; width: 100%; justify-content: space-between; }
        .reminder-actions label { display: flex; align-items: center; gap: 0.5rem; font-weight: normal; font-size: 0.9rem; margin-bottom: 0;}
        .view-all-controls { margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;}

        .hidden { display: none; }

        /* ----------- Custom Theme Extension ----------- */
        body.theme-custom {
            background: var(--bg);
            color: var(--fg);
        }
        .theme-custom .container,
        body.theme-custom .container {
            background: var(--item-bg);
            color: var(--item-fg);
        }
        .theme-custom .reminder-item {
            background: var(--bg);
            color: var(--fg);
        }
        .theme-custom .reminder-item.completed .reminder-text {
            color: var(--fg);
            opacity: 0.6;
        }
        .theme-custom .reminder-text {
            color: var(--fg);
        }
        .theme-custom .reminder-date {
            color: var(--accent);
        }
        .theme-custom button {
            background: var(--accent);
            color: var(--button-text);
        }
        .theme-custom button.secondary {
            background-color: var(--menu-hover-bg);
            color: var(--menu-fg);
        }
        .theme-custom button.danger {
            background-color: #e74c3c;
            color: #fff;
        }
        .theme-custom .settings-menu {
            background: var(--menu-bg);
            color: var(--menu-fg);
        }
        .theme-custom .settings-menu li button,
        .theme-custom .settings-menu li button.custom-theme-btn {
            color: var(--menu-fg);
        }
        .theme-custom .settings-menu li button:hover,
        .theme-custom .settings-menu li button.custom-theme-btn:hover {
            background: var(--menu-hover-bg);
            color: var(--menu-fg);
        }
        .theme-custom .separator {
            border-color: var(--separator-color);
        }
        .theme-custom .modal-content {
            background: var(--item-bg);
            color: var(--item-fg);
        }
        .theme-custom input[type="text"], .theme-custom input[type="date"], .theme-custom select, .theme-custom input.flatpickr-input {
            background-color: var(--input-bg);
            color: var(--input-fg);
            border: 1px solid var(--input-border);
        }
        .theme-custom input[type="text"]:focus, .theme-custom input[type="date"]:focus, .theme-custom select:focus, .theme-custom input.flatpickr-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-hover);
            color: var(--input-fg);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <input type="file" id="importFileTrigger" accept="application/json" style="display:none;">

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <script type="text/babel">

        // --- COLOR HELPERS & CONTRAST LOGIC ---

        function hexToRgb(hex) {
            hex = hex.replace("#", "");
            if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
            const bigint = parseInt(hex, 16);
            return [ (bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255 ];
        }
        function rgbToHex(r, g, b) {
            return "#" + [r,g,b].map(x => x.toString(16).padStart(2, "0")).join("");
        }
        function blendColors(hexA, hexB, percent) {
            const [r1,g1,b1] = hexToRgb(hexA), [r2,g2,b2] = hexToRgb(hexB);
            return rgbToHex(
                Math.round(r1 * (1-percent) + r2 * percent),
                Math.round(g1 * (1-percent) + g2 * percent),
                Math.round(b1 * (1-percent) + b2 * percent)
            );
        }
        function luminance([r, g, b]) {
            const a = [r, g, b].map(v => {
                v /= 255;
                return v <= 0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055, 2.4);
            });
            return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
        }
        function getContrastRatio(hexA, hexB) {
            const lumA = luminance(hexToRgb(hexA));
            const lumB = luminance(hexToRgb(hexB));
            return (Math.max(lumA, lumB) + 0.05) / (Math.min(lumA, lumB) + 0.05);
        }
        function getContrastYIQ(hexcolor){
            hexcolor = hexcolor.replace("#", "");
            const r = parseInt(hexcolor.substr(0,2),16);
            const g = parseInt(hexcolor.substr(2,2),16);
            const b = parseInt(hexcolor.substr(4,2),16);
            const yiq = ((r*299)+(g*587)+(b*114))/1000;
            return yiq;
        }

        // --- Helper Functions ---
        function setCookie(name, value, days = 365) {
            const d = new Date();
            d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/;SameSite=Lax`;
        }
        function getCookie(name) {
            const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? decodeURIComponent(v[2]) : null;
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            const [y, m, d] = dateString.split('-').map(Number);
            const dateObj = new Date(y, m - 1, d);
            return dateObj.toLocaleDateString(navigator.language, {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
            });
        }
        function formatDateTime(timestamp) {
             if (!timestamp) return '';
             return new Date(parseInt(timestamp)).toLocaleString(navigator.language, {
                 day: 'numeric',
                 month: 'short',
                 year: 'numeric',
                 hour: 'numeric',
                 minute: '2-digit'
             });
        }

        // --- CUSTOM THEME ADVANCED LOGIC ---
        const MIN_CONTRAST = 4.5; // WCAG AA for normal text

        const applyCustomThemeStyles = (color, type, notifyUser = true) => {
            const root = document.documentElement;
            let accent = color;
            let accentHover = blendColors(color, type === "light" ? "#000000" : "#ffffff", 0.2);

            // Calculate base/background colors
            const baseBgColor = type === "light" ? "#f9f9f9" : "#1a1a1a";
            const baseFgColor = type === "light" ? "#333333" : "#e0e0e0";
            const itemBg = type === "light" ? "#ffffff" : "#2a2a2a";
            const menuBg = type === "light" ? "#ffffff" : "#252525";
            const menuFg = type === "light" ? "#333333" : "#e0e0e0";
            const separatorColor = type === "light" ? "#e0e0e0" : "#444444";
            const inputBorder = blendColors(accent, baseBgColor, 0.75);

            // --- Set background to a very light or dark tint of the accent color ---
            const bgTint = blendColors(baseBgColor, accent, 0.10);

            // --- Set text color to a blended/tinted accent color ---
            let textTint = blendColors(baseFgColor, accent, 0.25);

            // --- Input background & text ---
            const inputBg = blendColors(itemBg, accent, 0.06);

            // --- Input text color: ensure high contrast with inputBg ---
            let inputFg = blendColors(baseFgColor, accent, 0.25);
            if (getContrastRatio(inputBg, inputFg) < MIN_CONTRAST) {
                inputFg = getContrastRatio(inputBg, baseFgColor) > getContrastRatio(inputBg, "#000") ?
                    baseFgColor : "#000";
                if (getContrastRatio(inputBg, inputFg) < MIN_CONTRAST) inputFg = "#fff";
            }

            // --- Button text color ---
            let buttonTextColor = getContrastYIQ(accent) >= 128 ? "#000" : "#fff";
            if (getContrastRatio(accent, buttonTextColor) < MIN_CONTRAST) {
                buttonTextColor = getContrastYIQ(accent) >= 128 ? "#222" : "#fff";
                if (getContrastRatio(accent, buttonTextColor) < MIN_CONTRAST) {
                    buttonTextColor = getContrastYIQ(accent) >= 128 ? "#000" : "#fff";
                }
            }

            // --- Fix for BAD accent color (e.g. white, too close to bg/input) ---
            let contrastFixed = false;
            if (getContrastRatio(accent, bgTint) < MIN_CONTRAST || getContrastRatio(accent, "#fff") < MIN_CONTRAST) {
                accent = type === "light"
                    ? blendColors(color, "#000000", 0.25)
                    : blendColors(color, "#ffffff", 0.25);
                accentHover = blendColors(accent, type === "light" ? "#000000" : "#ffffff", 0.2);
                contrastFixed = true;
            }

            // --- Apply all to :root ---
            root.style.setProperty('--bg', bgTint);
            root.style.setProperty('--fg', textTint);
            root.style.setProperty('--accent', accent);
            root.style.setProperty('--accent-hover', accentHover);
            root.style.setProperty('--item-bg', blendColors(itemBg, accent, 0.06));
            root.style.setProperty('--item-fg', textTint);
            root.style.setProperty('--menu-bg', menuBg);
            root.style.setProperty('--menu-fg', menuFg);
            root.style.setProperty('--menu-hover-bg', blendColors(menuBg, accent, 0.08));
            root.style.setProperty('--separator-color', separatorColor);
            root.style.setProperty('--input-border', inputBorder);
            root.style.setProperty('--button-text', buttonTextColor);
            root.style.setProperty('--input-bg', inputBg);
            root.style.setProperty('--input-fg', inputFg);

            document.body.className = 'theme-custom';

            if (contrastFixed && notifyUser) {
                alert("Your selected accent color did not have enough contrast for readability. The system has automatically adjusted it for better accessibility.");
            } else if (notifyUser && buttonTextColor !== (getContrastYIQ(accent) >= 128 ? "#000" : "#fff")) {
                alert("Button text color was automatically adjusted for readability.");
            }
        };

        // --- React Components (unchanged except calls to applyCustomThemeStyles) ---

        // ... [All React components are unchanged, only the applyCustomThemeStyles and new helpers are updated above] ...

        // SettingsMenu, CustomThemeModal, NamePrompt, ReminderItem, ReminderList
        // ... [see your original, unchanged implementations] ...

        // --- (Rest of React code below is unchanged) ---

        // SettingsMenu Component
        function SettingsMenu({ isOpen, onClose, onThemeChange, currentTheme, onImport, onExport, onOpenCustomTheme }) {
            const menuRef = React.useRef();
            React.useEffect(() => {
                function handleClickOutside(event) {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        if (!event.target.closest('.toolbar-btn')) {
                            onClose();
                        }
                    }
                }
                if (isOpen) {
                    document.addEventListener("mousedown", handleClickOutside);
                } else {
                    document.removeEventListener("mousedown", handleClickOutside);
                }
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, [isOpen, onClose]);
            const themes = ['default', 'dark', 'blue', 'green', 'purple', 'orange', 'teal'];
            return (
                <div ref={menuRef} className={`settings-menu ${isOpen ? 'open' : ''}`}>
                    <div className="settings-menu-section">
                        <div className="title">Data Sync</div>
                        <ul>
                            <li><button onClick={onImport}><i className="fas fa-file-import"></i> Import Reminders</button></li>
                            <li><button onClick={onExport}><i className="fas fa-file-export"></i> Export Reminders</button></li>
                        </ul>
                    </div>
                    <div className="separator"></div>
                    <div className="settings-menu-section">
                        <div className="title">Themes</div>
                        <div className="theme-options">
                            {themes.map(theme => (
                                <button
                                    key={theme}
                                    title={theme.charAt(0).toUpperCase() + theme.slice(1)}
                                    className={`theme-button ${currentTheme === theme ? 'active' : ''}`}
                                    data-theme={theme}
                                    onClick={() => onThemeChange(theme)}
                                >
                                    <span>{theme}</span>
                                </button>
                            ))}
                        </div>
                         <ul>
                            <li>
                                <button onClick={onOpenCustomTheme} className="custom-theme-btn">
                                    <i className="fas fa-palette"></i> Custom Theme
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            );
        }
        function CustomThemeModal({ isOpen, onClose, onApply, currentCustomColor, currentThemeType }) {
            const [color, setColor] = React.useState(currentCustomColor || '#007bff');
            const [type, setType] = React.useState(currentThemeType || 'light');
            React.useEffect(() => {
                setColor(currentCustomColor || '#007bff');
                setType(currentThemeType || 'light');
            }, [currentCustomColor, currentThemeType, isOpen]);
            if (!isOpen) return null;
            const handleApply = () => {
                onApply(color, type);
                onClose();
            };
            const handleOverlayClick = (e) => {
                 if (e.target === e.currentTarget) {
                     onClose();
                 }
            };
            return (
                <div className={`modal-overlay ${isOpen ? 'open' : ''}`} onClick={handleOverlayClick}>
                    <div className="modal-content">
                        <h2>Customize Your Theme</h2>
                        <div>
                            <label htmlFor="customColor">Accent Color:</label>
                            <input
                                type="color"
                                id="customColor"
                                value={color}
                                onChange={(e) => setColor(e.target.value)}
                            />
                        </div>
                         <div>
                            <label htmlFor="themeType">Base Theme:</label>
                            <select id="themeType" value={type} onChange={(e) => setType(e.target.value)}>
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>
                        <div className="modal-actions">
                             <button onClick={handleApply}><i className="fas fa-check"></i> Apply Theme</button>
                             <button onClick={onClose} className="secondary"><i className="fas fa-times"></i> Cancel</button>
                        </div>
                    </div>
                </div>
            );
        }
        function NamePrompt({ isOpen, onSave }) {
            const [name, setName] = React.useState('');
            if (!isOpen) return null;
            const handleSave = () => {
                onSave(name.trim() || 'Friend');
            }
            return (
                 <div className={`modal-overlay ${isOpen ? 'open' : ''}`}>
                    <div className="modal-content">
                        <h2>Welcome!</h2>
                        <p>Please enter your name to get started.</p>
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="Your name..."
                            onKeyPress={(e) => e.key === 'Enter' && handleSave()}
                            autoFocus
                         />
                        <div className="modal-actions">
                            <button onClick={handleSave}>Continue</button>
                         </div>
                    </div>
                </div>
            );
        }
        function ReminderItem({ reminder, onToggleComplete, onDelete, isAllView = false }) {
            const handleDelete = () => {
                const itemElement = document.getElementById(`reminder-${reminder.id}`);
                if (itemElement && !isAllView) {
                    itemElement.classList.add('slide-out');
                    setTimeout(() => onDelete(reminder.id), 300);
                } else {
                    if (isAllView && !confirm(`Delete reminder "${reminder.text}"?`)) {
                       return;
                    }
                    onDelete(reminder.id);
                }
            };
            return (
                <li className={`reminder-item ${reminder.completed ? 'completed' : ''} ${!reminder.completed && !isAllView && new Date(reminder.date) <= new Date(new Date().toDateString()) ? 'shake' : ''}`} id={`reminder-${reminder.id}`}>
                     {!isAllView ? (
                        <>
                            <div className="reminder-details">
                                <input
                                    type="checkbox"
                                    checked={reminder.completed}
                                    onChange={() => onToggleComplete(reminder.id)}
                                    aria-label={`Mark ${reminder.text} as complete`}
                                />
                                <span className="reminder-text">
                                    {reminder.text}
                                    <span className="reminder-date">({formatDate(reminder.date)})</span>
                                </span>
                            </div>
                             <div className="reminder-item-actions">
                                <button onClick={handleDelete} className="trash-btn" title="Delete Reminder">
                                    <i className="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </>
                    ) : (
                        <div className="all-reminder-details">
                             <div><strong>{reminder.text}</strong></div>
                             <div><small>Due: {formatDate(reminder.date)}</small></div>
                             <div><small>Created: {formatDateTime(reminder.id)}</small></div>
                             <div className="reminder-actions">
                                 <label>
                                     <input
                                         type="checkbox"
                                         checked={reminder.completed}
                                         onChange={() => onToggleComplete(reminder.id)}
                                     /> Completed
                                 </label>
                                 <button onClick={handleDelete} className="trash-btn danger" title="Delete Reminder">
                                     <i className="fas fa-trash-alt"></i>
                                 </button>
                             </div>
                         </div>
                    )}
                </li>
            );
        }
        function ReminderList({ title, reminders, onToggleComplete, onDelete, showViewAllLink, onViewAll, emptyMessage, isAllView = false }) {
            if (!isAllView && reminders.length === 0) {
                 return null;
            }
            return (
                 <section>
                    {title && <div className="section-title">{title}</div>}
                    {reminders.length > 0 ? (
                        <ul className="reminder-list">
                            {reminders.map(reminder => (
                                <ReminderItem
                                    key={reminder.id}
                                    reminder={reminder}
                                    onToggleComplete={onToggleComplete}
                                    onDelete={onDelete}
                                    isAllView={isAllView}
                                />
                            ))}
                        </ul>
                    ) : (
                        <p>{emptyMessage}</p>
                    )}
                    {showViewAllLink && reminders.length > 0 && (
                        <div style={{ marginTop: '1rem' }}>
                            <a href="#" onClick={onViewAll} style={{ color: 'var(--accent)', fontWeight: 600, textDecoration: 'none' }}>
                                View All?
                            </a>
                        </div>
                    )}
                </section>
            );
        }

        // --- Main App ---
        function App() {
            const REMINDER_TRUNCATE_LIMIT = 3;

            const [userName, setUserName] = React.useState(null);
            const [greeting, setGreeting] = React.useState('');
            const [reminders, setReminders] = React.useState([]);
            const [newReminderText, setNewReminderText] = React.useState('');
            const [newReminderDate, setNewReminderDate] = React.useState('');
            const [theme, setTheme] = React.useState('default');
            const [customColor, setCustomColor] = React.useState(null);
            const [themeType, setThemeType] = React.useState('light');
            const [isSettingsOpen, setIsSettingsOpen] = React.useState(false);
            const [isCustomThemeOpen, setIsCustomThemeOpen] = React.useState(false);
            const [isNamePromptOpen, setIsNamePromptOpen] = React.useState(false);
            const [isGapiReady, setIsGapiReady] = React.useState(false);
            const [view, setView] = React.useState('main');

            const flatpickrRef = React.useRef(null);
            const dateInputRef = React.useRef(null);
            const importFileRef = React.useRef(null);

            React.useEffect(() => {
                const storedName = getCookie('username');
                if (storedName) {
                    setUserName(storedName);
                    updateGreeting(storedName);
                } else {
                    setIsNamePromptOpen(true);
                }

                const storedTheme = getCookie('theme') || 'default';
                const storedCustomColor = getCookie('customColor');
                const storedThemeType = getCookie('themeType') || 'light';

                setTheme(storedTheme);
                if (storedTheme === 'custom' && storedCustomColor) {
                    setCustomColor(storedCustomColor);
                    setThemeType(storedThemeType);
                    applyCustomThemeStyles(storedCustomColor, storedThemeType, false);
                } else {
                    document.body.className = `theme-${storedTheme}`;
                }

                const storedReminders = getCookie('reminders');
                if (storedReminders) {
                    try {
                        setReminders(JSON.parse(storedReminders));
                    } catch (e) {
                        console.error("Failed to parse reminders from cookie:", e);
                        setReminders([]);
                    }
                 }

                importFileRef.current = document.getElementById('importFileTrigger');
                importFileRef.current.addEventListener('change', handleFileImport);

                 return () => {
                    if (importFileRef.current) {
                        importFileRef.current.removeEventListener('change', handleFileImport);
                    }
                 };
            }, []);

            React.useEffect(() => {
                if (dateInputRef.current && !flatpickrRef.current) {
                    flatpickrRef.current = flatpickr(dateInputRef.current, {
                        altInput: true,
                        altFormat: "d M Y",
                        dateFormat: "Y-m-d",
                        onChange: (selectedDates, dateStr) => {
                            setNewReminderDate(dateStr);
                        },
                         onOpen: function(selectedDates, dateStr, instance) {
                            instance.calendarContainer.classList.add(`theme-${theme}`);
                         },
                         onMonthChange: function(selectedDates, dateStr, instance) {
                             instance.calendarContainer.classList.add(`theme-${theme}`);
                         },
                          onYearChange: function(selectedDates, dateStr, instance) {
                              instance.calendarContainer.classList.add(`theme-${theme}`);
                          }
                    });
                }
                return () => {
                    if (flatpickrRef.current) {
                        flatpickrRef.current.destroy();
                        flatpickrRef.current = null;
                    }
                };
            }, [theme]);

            React.useEffect(() => {
                setCookie('reminders', JSON.stringify(reminders));
            }, [reminders]);

            const updateGreeting = (name) => {
                const msgs = [
                    `Welcome back, <strong>${name}</strong>!`,
                    `Good to see you, <strong>${name}</strong>.`,
                    `What's on the agenda, <strong>${name}</strong>?`,
                    `Let's get things done, <strong>${name}</strong>.`
                ];
                setGreeting(msgs[Math.floor(Math.random() * msgs.length)]);
            };
            const handleSaveName = (name) => {
                setUserName(name);
                setCookie('username', name);
                updateGreeting(name);
                setIsNamePromptOpen(false);
            };

            const handleThemeChange = (newTheme) => {
                setTheme(newTheme);
                setIsSettingsOpen(false);
                setCookie('theme', newTheme);

                if (newTheme === 'custom') {
                     if (!customColor) {
                        setIsCustomThemeOpen(true);
                     } else {
                         applyCustomThemeStyles(customColor, themeType);
                     }
                } else {
                    document.body.className = `theme-${newTheme}`;
                    document.documentElement.style.removeProperty('--accent');
                    document.documentElement.style.removeProperty('--accent-hover');
                    document.documentElement.style.removeProperty('--button-text');
                    document.documentElement.style.removeProperty('--bg');
                    document.documentElement.style.removeProperty('--fg');
                    document.documentElement.style.removeProperty('--item-bg');
                    document.documentElement.style.removeProperty('--item-fg');
                    document.documentElement.style.removeProperty('--menu-bg');
                    document.documentElement.style.removeProperty('--menu-fg');
                    document.documentElement.style.removeProperty('--menu-hover-bg');
                    document.documentElement.style.removeProperty('--separator-color');
                    document.documentElement.style.removeProperty('--input-border');
                    document.documentElement.style.removeProperty('--input-bg');
                    document.documentElement.style.removeProperty('--input-fg');
                }
            };

            const handleApplyCustomTheme = (color, type) => {
                setCustomColor(color);
                setThemeType(type);
                setTheme('custom');
                applyCustomThemeStyles(color, type, true);
                setCookie('theme', 'custom');
                setCookie('customColor', color);
                setCookie('themeType', type);
             };

            const addReminder = (e) => {
                e.preventDefault();
                if (!newReminderText.trim() || !newReminderDate) return;
                const newReminder = {
                    id: Date.now(),
                    text: newReminderText.trim(),
                    date: newReminderDate,
                    completed: false,
                };
                setReminders(prev => [...prev, newReminder].sort((a, b) => a.date.localeCompare(b.date)));
                setNewReminderText('');
                setNewReminderDate('');
                if (flatpickrRef.current) {
                    flatpickrRef.current.clear();
                }
            };

            const toggleComplete = (id) => {
                setReminders(prev =>
                    prev.map(r => r.id === id ? { ...r, completed: !r.completed } : r)
                );
            };

            const deleteReminder = (id) => {
                 setReminders(prev => prev.filter(r => r.id !== id));
            };

             const handleImportClick = () => {
                if (importFileRef.current) {
                     importFileRef.current.value = null;
                     importFileRef.current.click();
                 }
                 setIsSettingsOpen(false);
            };

            const handleFileImport = (event) => {
                const file = event.target.files[0];
                 if (!file) return;
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     try {
                         const importedReminders = JSON.parse(e.target.result);
                         if (Array.isArray(importedReminders)) {
                             setReminders(importedReminders.sort((a, b) => a.date.localeCompare(b.date)));
                             alert('Reminders imported successfully!');
                         } else {
                             alert('Invalid file format. Please import a valid JSON array of reminders.');
                         }
                     } catch (error) {
                         console.error("Error parsing imported file:", error);
                         alert('Error importing reminders. Please ensure the file is correct JSON format.');
                     }
                 };
                 reader.readAsText(file);
             };

            const handleExportClick = () => {
                if (reminders.length === 0) {
                    alert("No reminders to export.");
                    return;
                }
                const jsonString = JSON.stringify(reminders, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'reminders.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                 setIsSettingsOpen(false);
            };

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const dueReminders = reminders.filter(r => !r.completed && new Date(r.date) <= today);
            const upcomingReminders = reminders.filter(r => r.completed || new Date(r.date) > today);

            const limitedUpcomingReminders = upcomingReminders.slice(0, REMINDER_TRUNCATE_LIMIT);
            const showViewAll = upcomingReminders.length > REMINDER_TRUNCATE_LIMIT;

            if (view === 'all') {
                return (
                    <div className="container" id="allView">
                         <div className="view-all-controls">
                            <h1>All Reminders</h1>
                             <button onClick={() => setView('main')} className="secondary"><i className="fas fa-arrow-left"></i> Back to Main</button>
                        </div>
                        <ReminderList
                            reminders={reminders}
                            onToggleComplete={toggleComplete}
                            onDelete={deleteReminder}
                            emptyMessage="You have no reminders at all."
                            isAllView={true}
                         />
                     </div>
                );
            }

             return (
                <div className="container" id="mainContainer">
                    <div className="toolbar">
                        <button
                             className="toolbar-btn icon-btn"
                             onClick={() => setIsSettingsOpen(o => !o)}
                             title="Settings"
                         >
                            <i className="fas fa-cog"></i>
                         </button>
                         <SettingsMenu
                            isOpen={isSettingsOpen}
                            onClose={() => setIsSettingsOpen(false)}
                            onThemeChange={handleThemeChange}
                            currentTheme={theme}
                            onImport={handleImportClick}
                            onExport={handleExportClick}
                            onOpenCustomTheme={() => { setIsCustomThemeOpen(true); setIsSettingsOpen(false); }}
                         />
                    </div>
                    {greeting && <div className="greeting" dangerouslySetInnerHTML={{ __html: greeting }}></div>}
                     {dueReminders.length > 0 && (
                        <div className="due-banner">
                            You have {dueReminders.length} reminder(s) due!
                        </div>
                    )}
                    <form onSubmit={addReminder}>
                        <div className="form-group">
                            <label htmlFor="reminderText">New Reminder</label>
                            <input
                                type="text"
                                id="reminderText"
                                value={newReminderText}
                                onChange={(e) => setNewReminderText(e.target.value)}
                                placeholder="What do you want to remember?"
                            />
                        </div>
                        <div className="form-group">
                             <label htmlFor="reminderDate">Due Date</label>
                             <input
                                ref={dateInputRef}
                                type="text"
                                id="reminderDate"
                                placeholder="Select date..."
                                readOnly
                            />
                        </div>
                         <div className="form-actions">
                            <button type="submit"><i className="fas fa-plus"></i> Add Reminder</button>
                        </div>
                    </form>
                    {reminders.length > 0 && <div className="separator"></div>}
                    <ReminderList
                         title="Due Reminders"
                         reminders={dueReminders}
                         onToggleComplete={toggleComplete}
                         onDelete={deleteReminder}
                         emptyMessage="No due reminders. Great job!"
                     />
                     {dueReminders.length > 0 && upcomingReminders.length > 0 && <div className="separator"></div>}
                     <ReminderList
                         title="Upcoming & Completed"
                         reminders={limitedUpcomingReminders}
                         onToggleComplete={toggleComplete}
                         onDelete={deleteReminder}
                         showViewAllLink={showViewAll}
                         onViewAll={(e) => { e.preventDefault(); setView('all'); }}
                         emptyMessage="No upcoming or completed reminders."
                     />
                    <NamePrompt
                        isOpen={isNamePromptOpen}
                        onSave={handleSaveName}
                    />
                    <CustomThemeModal
                        isOpen={isCustomThemeOpen}
                        onClose={() => setIsCustomThemeOpen(false)}
                        onApply={handleApplyCustomTheme}
                         currentCustomColor={customColor}
                         currentThemeType={themeType}
                     />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
